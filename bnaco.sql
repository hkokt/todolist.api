START TRANSACTION;

-- ------------------------------------------------------- CRIAR DATABASE
SET
   SQL_MODE = "NO_AUTO_VALUE_ON_ZERO",
   time_zone = "-03:00";

DROP DATABASE IF EXISTS db_todolist;

CREATE DATABASE db_todolist;

USE db_todolist;

-- ------------------------------------------------------- CRIAR TABLES
CREATE TABLE tb_user (
   idUser INT AUTO_INCREMENT PRIMARY KEY,
   Nome VARCHAR(50)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

CREATE TABLE tb_tarefa (
   idTarefa INT AUTO_INCREMENT PRIMARY KEY,
   idUser INT,
   Titulo VARCHAR(30),
   Descricao TEXT,
   Insercao TIMESTAMP NOT NULL DEFAULT current_timestamp()
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

CREATE TABLE tb_log_tarefa (
   idLog INT AUTO_INCREMENT PRIMARY KEY,
   idUser INT,
   idTarefa INT,
   tipoAlteracao CHAR(6),
   dataHora TIMESTAMP NOT NULL DEFAULT current_timestamp()
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

-- ------------------------------------------------------- CRIAR FOREIGN KEYS
ALTER TABLE
   tb_tarefa
ADD
   CONSTRAINT FK_USER_TAREFA FOREIGN KEY (idUser) REFERENCES tb_user(idUser);

-- ------------------------------------------------------- INSERINDO DADOS
INSERT INTO
   tb_user (Nome)
VALUES
   ('Matheus'),
   ('Hugo');

INSERT INTO
   tb_tarefa (idUser, Titulo, Descricao)
VALUES
   (
      1,
      'Louça',
      'Lavar a louça'
   ),
   (
      2,
      'Lixo',
      'Devo tirar o lixo'
   ),
   (
      1,
      'Compras',
      'Lista de compras'
   ),
   (
      2,
      'Estudo',
      'Preparar para exame'
   ),
   (
      1,
      'Exercícios',
      'Treino diário'
   ),
   (
      2,
      'Leitura',
      'Livro recomendado'
   ),
   (
      1,
      'Trabalho',
      'Projeto importante'
   ),
   (
      2,
      'Limpeza',
      'Organizar quarto'
   ),
   (
      1,
      'Cozinha',
      'Experimentar nova receita'
   ),
   (
      2,
      'Expediente',
      'Reunião de equipe'
   ),
   (
      1,
      'Saúde',
      'Consulta médica'
   ),
   (
      2,
      'Finanças',
      'Orçamento mensal'
   );

-- ------------------------------------------------------- PROCEDURES
DELIMITER / /
CREATE PROCEDURE searchByUser(IN p_idUser INT) BEGIN
SELECT
   idTarefa,
   Titulo,
   Descricao,
   Insercao
FROM
   tb_tarefa t
   INNER JOIN tb_user u ON u.idUser = t.idUser
WHERE
   u.idUser = p_idUser
ORDER BY
   Insercao,
   Titulo;

END / /
DELIMITER ;

DELIMITER / /
CREATE PROCEDURE searchByTitle(IN paramTitulo VARCHAR(30)) BEGIN
SELECT
   idTarefa,
   idUser,
   Titulo,
   Descricao,
   Insercao
FROM
   tb_tarefa t
WHERE
   Titulo LIKE CONCAT('%', paramTitulo, '%');

END / /

DELIMITER ;

DELIMITER / /
CREATE PROCEDURE putTarefa(
   in p_idUser INT,
   in p_Titulo VARCHAR(30),
   in p_Descricao TEXT
) BEGIN
INSERT INTO
   tb_tarefa (idUser, Titulo, Descricao)
VALUES
   (p_idUser, p_Titulo, p_Descricao);

END / /

DELIMITER ;

DELIMITER / /
CREATE PROCEDURE updateTarefa(
   in p_idTarefa int,
   in p_Titulo VARCHAR(30),
   in p_Descricao TEXT
) BEGIN
UPDATE
   tb_tarefa
SET
   Titulo = p_Titulo,
   Descricao = p_Descricao
WHERE
   idTarefa = p_idTarefa;

END / /

DELIMITER ;

DELIMITER / /
CREATE PROCEDURE deleteTarefa(in p_idTarefa int) BEGIN
DELETE FROM
   tb_tarefa
WHERE
   idTarefa = p_idTarefa;

END / /

DELIMITER ;

-- ------------------------------------------------------- TRIGGERS
DELIMITER / /
CREATE TRIGGER trg_update_tarefa
AFTER
UPDATE
   ON tb_tarefa FOR EACH ROW BEGIN
INSERT INTO
   tb_log_tarefa (idUser, idTarefa, tipoAlteracao)
VALUES
   (OLD.idUser, OLD.idTarefa, "UPDATE");

END / /

DELIMITER / /
CREATE TRIGGER trg_insert_tarefa
AFTER
INSERT
   ON tb_tarefa FOR EACH ROW BEGIN
INSERT INTO
   tb_log_tarefa (idUser, idTarefa, tipoAlteracao)
VALUES
   (NEW.idUser, NEW.idTarefa, "INSERT");

END / /

DELIMITER / /
CREATE TRIGGER trg_delete_tarefa
AFTER
   DELETE ON tb_tarefa FOR EACH ROW BEGIN
INSERT INTO
   tb_log_tarefa (idUser, idTarefa, tipoAlteracao)
VALUES
   (OLD.idUser, OLD.idTarefa, "DELETE");
END / /

DELIMITER ;

COMMIT;